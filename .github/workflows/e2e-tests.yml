name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      subset:
        description: 'Test subset to run'
        required: false
        default: 'critical'
        type: choice
        options:
          - critical
          - all

env:
  E2E_BASE_URL: ${{ secrets.E2E_BASE_URL || 'https://tuqui-agents-alpha.vercel.app' }}
  INTERNAL_TEST_KEY: ${{ secrets.INTERNAL_TEST_KEY }}

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for Vercel deployment
        if: github.event_name == 'push'
        run: |
          echo "Waiting 60s for Vercel deployment..."
          sleep 60

      - name: Run E2E tests (critical subset)
        if: github.event.inputs.subset != 'all'
        run: npm run test:e2e:critical
        env:
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}
          INTERNAL_TEST_KEY: ${{ secrets.INTERNAL_TEST_KEY }}

      - name: Run E2E tests (all)
        if: github.event.inputs.subset == 'all'
        run: npm run test:e2e
        env:
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}
          INTERNAL_TEST_KEY: ${{ secrets.INTERNAL_TEST_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: scripts/e2e-tests/results/
          retention-days: 30

      - name: Create test summary
        if: always()
        run: |
          if [ -f "scripts/e2e-tests/results/latest.json" ]; then
            echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract stats using jq
            PASSED=$(jq '.passed' scripts/e2e-tests/results/latest.json)
            FAILED=$(jq '.failed' scripts/e2e-tests/results/latest.json)
            TOTAL=$(jq '.total' scripts/e2e-tests/results/latest.json)
            RATE=$(jq '.passRate' scripts/e2e-tests/results/latest.json)
            AVG_LATENCY=$(jq '.avgLatency' scripts/e2e-tests/results/latest.json)
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Pass Rate | ${RATE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Avg Latency | ${AVG_LATENCY}ms |" >> $GITHUB_STEP_SUMMARY
            
            # List failures if any
            if [ "$FAILED" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.suites[] | .results[] | select(.passed == false) | "- **\(.suite)/\(.id)**: \(.question | .[0:80])..."' scripts/e2e-tests/results/latest.json >> $GITHUB_STEP_SUMMARY
            fi
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ðŸš¨ E2E Tests Failed on Main',
              body: `## E2E Test Failure
              
              The E2E tests failed on the main branch.
              
              **Run:** ${runUrl}
              **Commit:** ${context.sha}
              **Author:** @${context.actor}
              
              Please investigate and fix the issues.`,
              labels: ['bug', 'e2e-tests', 'automated']
            });
